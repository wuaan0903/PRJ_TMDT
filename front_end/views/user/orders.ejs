<%- layout('../layouts/index') %>

<style>
    /* ƒë·ªãnh d·∫°ng Header */
     .custom-header {
                background: #fff;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                padding: 20px;
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
        /* TƒÉng k√≠ch th∆∞·ªõc icon */
        .custom-header i {
            font-size: 24px;
            color: #fbc02d; /* M√†u v√†ng gi·ªëng v∆∞∆°ng mi·ªán */
        }
    /* Sidebar */
    .sidebar {
        background: #d9d9d9;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        height: fit-content;
    }

    .list-group-item {
        
        font-size: 16px;
        padding: 12px 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #333;
        transition: all 0.3s ease-in-out;
        text-decoration: none;
        border-radius: 8px;
        background: #fff;
        
    }

    .list-group-item i {
        font-size: 18px;
    }

    /* Hover */
    .list-group-item:hover {
        background: #000;
        color: #fff !important;
        transform: translateY(-3px);
    }

    /* Active */
    .list-group-item.active {
        background: #000 !important;
        color: #fff !important;
    }

    /* Logout - ƒêƒÉng xu·∫•t */
    .list-group-item.text-danger {
        font-weight: bold;
    }

    /* Hover ri√™ng cho ƒêƒÉng xu·∫•t */
    .list-group-item.text-danger:hover {
        background: #dc3545 !important;
        color: #fff !important;
    }

    .order-container {
        

        padding: 20px 40px;
        margin-bottom: 30px;
        border-radius: 10px;
        min-height: 442px;
        background: #d9d9d9;
    }
    .order-header {
        font-size: 30px;
        font-weight: 500;
        padding-top: 10px;
        margin-bottom: 20px;
    }
    .order-card {
        background: #212121;
        color: #fff;
        padding: 10px 24px;
        border-radius: 5px;
    }
    .order-item {
        background: #f1f1f1;
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        
    }
    .btn-custom {
        background: #f1f1f1;
        color: rgb(0, 0, 0);
        border: 1px solid #000000;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        padding: 8px 36px;
    }

    .btn-custom1 {
        background: #000;
        color: #fff;
        border: 1px solid #000000;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        padding: 8px 36px;
    }
    .btn-custom:hover {
        background: #000;
        color: #fff;
    }
    .btn-custom1:hover {
        border: 1px solid #000000;
        background: #222222;
        color: #fff;
    }
    .order{
        margin-bottom: 20px;
    }

    .star-rating {
        font-size: 24px;
        color: #ddd;
        cursor: pointer;
    }
    .star-rating .fas.selected {
        color: #fbc02d;
    }

</style>

<!-- Bootstrap Grid Layout -->
<div class="container pt-5" style="
margin: 0;
margin-top: 60px;
max-width: 100%;
padding: 0 50px;
">
    <div class="row">
        <ul class="side-menu top">
        <div class="custom-header ">
            <!-- B√™n tr√°i -->
            <div id="nameKH" class="left">
                <h4>Hi, <span class="fw-bold"></span> <i class='bx bx-crown' ></i></h4>
            </div> 
        </div>
        </ul>
        <!-- Sidebar b√™n tr√°i -->
        <div class="col-md-3">
            <div class="sidebar">
                <ul class="side-menu top list-unstyled">
                    <div class="row g-2" id="user-sidebar">
                        <div class="col-12">
                            <a href="/user/profile" class="list-group-item list-group-item-action rounded-3 d-flex align-items-center  w-100 " style="
                            font-size: 15px;
                            letter-spacing: -1px;
                            font-weight: 600;
                        ">
                                <i class="fas fa-user"></i> Th√¥ng tin t√†i kho·∫£n
                            </a>
                        </div>
                        <div class="col-12">
                            <a href="/user/orders" class="list-group-item list-group-item-action rounded-3 d-flex align-items-center w-100 text-white bg-dark" style="
                            font-size: 15px;
                            letter-spacing: -1px;
                            font-weight: 600;
                        ">
                                <i class="fas fa-shopping-bag"></i> L·ªãch s·ª≠ ƒë∆°n h√†ng
                            </a>
                        </div>
                        <div class="col-12">
                            <a href="/user/vouchers" class="list-group-item list-group-item-action rounded-3 d-flex align-items-center w-100" style="
                            font-size: 15px;
                            letter-spacing: -1px;
                            font-weight: 600;
                        ">
                                <i class="fas fa-gift"></i> V√≠ Voucher
                            </a>
                        </div>
                        <div class="col-12">
                            <a href="/user/address" class="list-group-item list-group-item-action rounded-3 d-flex align-items-center w-100" style="
                            font-size: 15px;
                            letter-spacing: -1px;
                            font-weight: 600;
                        ">
                                <i class="fas fa-map-marker-alt"></i> S·ªï ƒë·ªãa ch·ªâ
                            </a>
                        </div>
                        
                        <div class="col-12">
                            <a href="/user/policies" class="list-group-item list-group-item-action rounded-3 d-flex align-items-center w-100" style="
                            font-size: 15px;
                            letter-spacing: -1px;
                            font-weight: 600;
                        ">
                                <i class="fas fa-question-circle"></i> Ch√≠nh s√°ch & C√¢u h·ªèi th∆∞·ªùng g·∫∑p
                            </a>
                        </div>
                        <div class="col-12">
                            <a href="/auth/logout" class="list-group-item list-group-item-action text-danger rounded-3 d-flex align-items-center w-100" style="
                            font-size: 15px;
                            letter-spacing: -1px;
                            font-weight: 600;
                        ">
                                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                            </a>
                        </div>
                    </div>
                </ul>
            </div>
        </div>

            <!-- N·ªôi dung b√™n ph·∫£i -->
            <div class="col-md-9">

                <div class="container" style="
                padding: 0;
            ">
                    <div class="order-container">
                        <h2 class="order-header">L·ªãch s·ª≠ ƒë∆°n h√†ng</h2>
                        <p>ƒê∆°n h√†ng c·ªßa b·∫°n: <strong id="order-count">0 ƒë∆°n h√†ng</strong></p>
                        <div class="order-container1">

                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

<!-- Modal ƒë√°nh gi√° s·∫£n ph·∫©m -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="
        transform: translateY(100px);
    ">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">ƒê√°nh gi√° s·∫£n ph·∫©m</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="productReviews" class="mb-3">
                    <!-- C√°c tr∆∞·ªùng ƒë√°nh gi√° cho t·ª´ng s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y -->
                </div>
                <button type="submit" class="btn btn-primary" style="background: #111111;border: none;width: 100%;font-size: 14px;font-weight: 500;" id="submitReviews">Ho√†n th√†nh</button>
            </div>
        </div>
    </div>
</div>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            let userId;

            const statusMap = {
                'pending': 'Ch·ªù x√°c nh·∫≠n',
                'processing': 'ƒêang giao h√†ng',
                'completed': 'Ho√†n th√†nh',
                'cancelled': 'ƒê√£ h·ªßy'
            };
    
            // G·ªçi API ƒë·ªÉ l·∫•y ID ng∆∞·ªùi d√πng
            fetch('/auth/user')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        // Redirect to login page if not logged in
                        window.location.href = '/login';
                        throw new Error('Not logged in');
                    }
                })
                .then(userData => {
                    userId = userData.user.user._id;
                    console.log('User ID:', userId);
                    const nameKH = document.getElementById('nameKH');
                nameKH.innerHTML = `
                <h4>Hi, <span class="fw-bold">${userData.user.user.username}</span> <i class='bx bx-crown' ></i></h4>
                `;
                    fetchOrders(userId);
                })
                .catch(error => {
                    console.error('Error fetching user ID:', error);
                });

                let productDetails1 = {};
    
                // H√†m ƒë·ªÉ g·ªçi API l·∫•y danh s√°ch ƒë∆°n h√†ng
            async function fetchOrders(userId) {
                try {
                    const response = await fetch(`http://localhost:3000/api/orders/user/${userId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const orders = await response.json();
                    const productDetails = await fetchProductDetails(orders);
                    productDetails1=productDetails;
                    // S·∫Øp x·∫øp danh s√°ch ƒë∆°n h√†ng theo ng√†y
                    orders.sort((a, b) => new Date(b.date) - new Date(a.date));
                    displayOrders(orders, productDetails);
                    displayOrderCount(orders.length);
                } catch (error) {
                    console.error('Error fetching orders:', error);
                }
            }
    
            // H√†m ƒë·ªÉ g·ªçi API l·∫•y chi ti·∫øt s·∫£n ph·∫©m
            async function fetchProductDetails(orders) {
                const productIds = orders.flatMap(order => order.products.map(product => product.productId));
                const uniqueProductIds = [...new Set(productIds)];
                const productDetails = await Promise.all(uniqueProductIds.map(async productId => {
                    const response = await fetch(`http://localhost:3002/api/products/${productId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                }));
                return productDetails.reduce((acc, product) => {
                    acc[product._id] = product;
                    return acc;
                }, {});
            }
    
            // H√†m ƒë·ªÉ hi·ªÉn th·ªã s·ªë l∆∞·ª£ng ƒë∆°n h√†ng
            function displayOrderCount(count) {
                const orderCountElement = document.getElementById('order-count');
                orderCountElement.textContent = `${count} ƒë∆°n h√†ng`;
            }


                // H√†m ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch ƒë∆°n h√†ng
                function displayOrders(orders, productDetails) {
                    const orderContainer = document.querySelector('.order-container1');
                    orderContainer.innerHTML = '';

                    orders.forEach(order => {
                        const orderElement = document.createElement('div');
                        orderElement.className = 'order';
                        orderElement.innerHTML = `
                            <div class="order-card d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>#${order._id}</strong>
                                    <p style="margin: 0;">${new Date(order.date).toLocaleDateString()}</p>
                                </div>
                                <button class="btn btn-light" style="
                                border-radius: 16px;
                                font-size: 12px;
                                font-weight: 700;
                                letter-spacing: -1px;
                            ">${statusMap[order.status] || 'Kh√¥ng x√°c ƒë·ªãnh'}</button>
                            </div>
                            
                            ${order.products.map(product => {
                                const productDetail = productDetails[product.productId];
                                return `
                                <div class="order-item d-flex align-items-center">
                                    <img src="http://localhost:3002/api/products/thumbnail/${productDetail.thumbnail}" class="me-3" alt="S·∫£n ph·∫©m" style="
                                    width: 100px;
                                ">
                                    <div>
                                        <p style="
                                        font-size: 14px;
                                        letter-spacing: -1px;
                                    "><strong>${productDetail.name}</strong></p>
                                        <p style="
                                        font-size: 14px;
                                        font-weight: 500;
                                        letter-spacing: -1px;
                                        color: #626262;
                                        margin-bottom: 10px;
                                    ">Size : ${product.size}</p>
                                        <p style="
                                        font-size: 14px;
                                        font-weight: 500;
                                        letter-spacing: -1px;
                                        margin-bottom: 10px;
                                    ">x${product.quantity}</p>

                                    <p style="
                                        font-size: 14px;
                                        font-weight: 500;
                                        letter-spacing: -1px;
                                        margin-bottom: 10px;
                                        font-weight: 700;
                                    ">${productDetail.price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}</p>
                                    </div>
                                    
                                </div>
                                `;
                            }).join('')}
                            
                            <div class="d-flex justify-content-between fw-bold" style="
                            padding: 10px 20px;
                            background: #f1f1f1;
                        ">
                        <div>
                            <a href="http://localhost:3000/user/orders/${order._id}" class="btn btn-custom">Chi ti·∫øt</a>
                            ${order.status !== 'completed' && order.status !== 'cancelled' && order.status !== 'processing' ? `<button id="cancellOrder" class="btn btn-custom1 cancellOrder" data-order-id="${order._id}">H·ªßy ƒë∆°n</button>` : ''}
                            ${order.status === 'completed' && order.rating === false ? `<button id="reviewOrder" class="btn btn-custom1 reviewOrder" data-order-id="${order._id}">ƒê√°nh gi√°</button>` : ''}
                        </div>


                                
                                <span style="
                                align-content: center;
                                font-size: 18px;
                                font-weight: 600;
                            ">${order.totalAmount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}</span>
                            </div>
                        `;
                        orderContainer.appendChild(orderElement);
                    });

                    // Th√™m s·ª± ki·ªán click cho n√∫t "ƒê√°nh gi√°"
                    document.querySelectorAll('.reviewOrder').forEach(button => {
                        button.addEventListener('click', function () {
                            const orderId = this.getAttribute('data-order-id');
                            const products = orders.find(order => order._id === orderId).products;
                            console.log(products);
                            showReviewModal(orderId, products);
                        });
                    });


                    document.querySelectorAll('.cancellOrder').forEach(button => {
                        button.addEventListener('click', async function () {
                            const orderId = this.getAttribute('data-order-id');
                            Swal.fire({
                                title: "B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y kh√¥ng?",
                                text: "B·∫°n s·∫Ω kh√¥ng th·ªÉ kh√¥i ph·ª•c l·∫°i ƒë∆°n h√†ng sau khi ƒë√£ h·ªßy.",
                                icon: "warning",
                                showCancelButton: true,
                                confirmButtonColor: "#3085d6",
                                cancelButtonColor: "#d33",
                                confirmButtonText: "Yes"  
                            }).then(async (result) => { // Th√™m async v√†o ƒë√¢y
                                if (result.isConfirmed) {
                                    try {
                                        // G·ªçi API ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh "cancelled"
                                        const response = await fetch(`/api/orders/${orderId}`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({ status: 'cancelled' }),
                                        });
                    
                                        if (!response.ok) {
                                            throw new Error(`HTTP error! Status: ${response.status}`);
                                        }
                    
                                        
                                        fetchOrders(userId); // T·∫£i l·∫°i danh s√°ch ƒë∆°n h√†ng sau khi h·ªßy th√†nh c√¥ng
                                    } catch (error) {
                                        console.error('Error cancelling order:', error);
                                        alert('ƒê√£ x·∫£y ra l·ªói khi h·ªßy ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.');
                                    }
                    
                                    Swal.fire({
                                        title: "ƒê√£ h·ªßy ƒë∆°n h√†ng!",
                                        text: "ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c h·ªßy th√†nh c√¥ng.",
                                        icon: "success"
                                    });
                                }
                            });
                        });
                    });
                    
            
                }


            // H√†m ƒë·ªÉ hi·ªÉn th·ªã modal ƒë√°nh gi√°
            function showReviewModal(orderId, products) {
                const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));

                // ƒêi·ªÅn th√¥ng tin s·∫£n ph·∫©m v√† c√°c tr∆∞·ªùng ƒë√°nh gi√° v√†o modal
                const productReviews = document.getElementById('productReviews');
                productReviews.innerHTML = products.map((product, index) => {
                    // L·∫•y th√¥ng tin s·∫£n ph·∫©m t·ª´ productDetails b·∫±ng productId
                    const productDetail = productDetails1[product.productId];
                
                    // Ki·ªÉm tra n·∫øu s·∫£n ph·∫©m t·ªìn t·∫°i trong productDetails
                    if (!productDetail) return '';
                
                    return `
                        <div class="product-review mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <img src="http://localhost:3002/api/products/thumbnail/${productDetail.thumbnail}" alt="S·∫£n ph·∫©m" style="width: 80px; margin-right: 20px;">
                                <div>
                                    <p style="font-size: 14px; font-weight: 600; margin: 0;">${productDetail.name}</p>
                                    <p style="font-size: 14px; font-weight: 500; color: #626262; margin: 0;">Size: ${product.size}</p>
                                    <p style="font-size: 14px; font-weight: 500; margin: 0;">x${product.quantity}</p>
                                    <p style="font-size: 14px; font-weight: 700; margin: 0;">${productDetail.price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}</p>
                                </div>
                            </div>
                            <div class="mb-3 d-flex align-items-center"> 
                                <label for="rating${index}" class="form-label m-0 pe-5" style="
    font-size: 14px;
    font-weight: 500;
">Ch·∫•t l∆∞·ª£ng s·∫£n ph·∫©m</label>
                                <div id="rating${index}" class="star-rating">
                                    <i class="fas fa-star selected" data-value="1"></i>
                                    <i class="fas fa-star selected" data-value="2"></i>
                                    <i class="fas fa-star selected" data-value="3"></i>
                                    <i class="fas fa-star selected" data-value="4"></i>
                                    <i class="fas fa-star selected" data-value="5"></i>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="reviewContent${index}" class="form-label" style="
    font-size: 14px;
    font-weight: 500;
">N·ªôi dung ƒë√°nh gi√°</label>
                                <textarea class="form-control" style="
    font-size: 14px;
    font-weight: 500;
" id="reviewContent${index}" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="reviewImage${index}" class="form-label" style="
    font-size: 14px;
    font-weight: 500;
">Th√™m ·∫£nh s·∫£n ph·∫©m</label>
                                <input class="form-control" style="
    font-size: 14px;
    font-weight: 500;
" type="file" id="reviewImage${index}" name="images" multiple accept="image/*">
                            </div>
                            <div class="mb-3">
                                <label for="reviewImage${index}" class="form-label"></label>
                                <img id="reviewImagePreview${index}" src="#" alt="·∫¢nh ƒë√°nh gi√°" style="display: none; width: 100px; height: auto; margin-top: 10px;">
                            </div>
                        </div>
                    `;
                }).join('');
                
                reviewModal.show();

                // X·ª≠ l√Ω s·ª± ki·ªán click v√†o sao ƒë·ªÉ ch·ªçn ƒë√°nh gi√°
                document.querySelectorAll('.star-rating .fas').forEach(star => {
                    star.addEventListener('click', function () {
                        const value = this.getAttribute('data-value');
                        const ratingId = this.parentElement.id;
                        document.querySelectorAll(`#${ratingId} .fas`).forEach(s => {
                            s.classList.remove('selected');
                            if (s.getAttribute('data-value') <= value) {
                                s.classList.add('selected');
                            }
                        });
                    });
                });

                async function uploadReviewImages(imageFiles) {
                    if (!imageFiles || imageFiles.length === 0) return;
                
                    const imageFormData = new FormData();
                    Array.from(imageFiles).forEach(file => imageFormData.append("images", file));
                
                    try {
                        const response = await fetch(`http://localhost:3002/api/reviewProduct/imageReview`, {
                            method: "POST",
                            body: imageFormData
                        });
                
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message);
                
                        console.log("·∫¢nh review ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n!", result.images);
                    } catch (error) {
                        console.error("L·ªói khi upload ·∫£nh review:", error);
                    }
                }

                // X·ª≠ l√Ω s·ª± ki·ªán submit form ƒë√°nh gi√°
                document.getElementById('submitReviews').addEventListener('click', async function (event) {
                    event.preventDefault();
                
                    const reviews = await Promise.all(products.map(async (product, index) => {
                        const stars = document.querySelectorAll(`#rating${index} .fas.selected`);
                        const rating = stars.length > 0 ? stars[stars.length - 1].getAttribute('data-value') : 0;

                        const reviewContent = document.getElementById(`reviewContent${index}`).value;
                        const reviewImages = document.getElementById(`reviewImage${index}`).files; // L·∫•y danh s√°ch ·∫£nh
                        
                        // **üìå G·ª≠i ·∫£nh l√™n server tr∆∞·ªõc khi t·∫°o review**
                            let uploadedImages = [];
                            if (reviewImages.length > 0) {
                                const imageFormData = new FormData();
                                Array.from(reviewImages).forEach(file => imageFormData.append("images", file));

                                try {
                                    const imageResponse = await fetch("http://localhost:3002/api/reviewProduct/imageReview", {
                                        method: "POST",
                                        body: imageFormData
                                    });

                                    if (!imageResponse.ok) {
                                        throw new Error(`HTTP error! Status: ${imageResponse.status}`);
                                    }

                                    const imageData = await imageResponse.json();
                                    uploadedImages = imageData.images; // Danh s√°ch ·∫£nh t·ª´ server
                                } catch (error) {
                                    console.error("Error uploading images:", error);
                                }
                            }
                        
                        return {
                            product_id: product.productId,
                            user_id: userId,
                            comment: reviewContent,
                            rate: rating,
                            image_review: uploadedImages // L∆∞u danh s√°ch ·∫£nh v√†o review
                        };
                    }));
                
                    try {
                        for (const review of reviews) {
                            console.log('Review data:', review);
                            const response = await fetch(`/api/review/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(review)
                            });
                
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                        }


                        // G·ªçi API ƒë·ªÉ c·∫≠p nh·∫≠t order.rating th√†nh true
                        const updateRatingResponse = await fetch(`/api/orders/rating/${orderId}`, {
                            method: 'PUT'
                        });

                        if (!updateRatingResponse.ok) {
                            throw new Error(`HTTP error! Status: ${updateRatingResponse.status}`);
                        }
                        
                
                        // ƒê√≥ng modal sau khi ƒë√°nh gi√° th√†nh c√¥ng
                        reviewModal.hide();
                        fetchOrders(userId);
                    } catch (error) {
                        console.error('Error submitting review:', error);
                    }
                });


            }
            
                // X·ª≠ l√Ω s·ª± ki·ªán click v√†o sao ƒë·ªÉ ch·ªçn ƒë√°nh gi√°
            document.querySelectorAll('#rating .fas').forEach(star => {
                star.addEventListener('click', function () {
                    const value = this.getAttribute('data-value');
                    document.querySelectorAll('#rating .fas').forEach(s => {
                        s.classList.remove('selected');
                        if (s.getAttribute('data-value') <= value) {
                            s.classList.add('selected');
                        }
                    });
                });
            });


            // G·ªçi h√†m fetchOrders khi trang ƒë∆∞·ª£c t·∫£i
            fetchOrders();


        });
    </script>