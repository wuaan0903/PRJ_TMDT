<%- layout('layouts/index') %>
<style>
    .form-control{
        height: 45px;
        width: 100%;
        outline: none;
        font-size: 16px;
        border-radius: 5px;
        padding-left: 15px;
        border: none;
        background: #ededed;
        transition: all 0.3s ease;
    }
    .btn-submit{
        border: none;
        padding: 20px;
        width: 100%;
        background: #000;
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        text-transform: uppercase;
        cursor: pointer;
    }
</style>
<div class="container my-5 px-5" style="padding-top:85px; margin-bottom:40px;">
    <div class="row justify-content-center pb-5 mt-4">
        <div class="col-md-5">
            <div class="heading-title d-flex justify-content-center">
                <h2 class="text-center mb-4 fw-bold fs-4">ƒêƒÇNG NH·∫¨P</h2>
                <h2 class="text-center mb-4 fw-bold fs-4">
                    <a href="/register" style="padding-left: 20px; margin-left: 20px;border-left: 2px solid #000;padding-right: 0;margin-right: 0;border-right: none; color: #cccccc; text-decoration:none;">ƒêƒÇNG K√ù</a>
                </h2>
            </div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label for="loginEmail" class="form-label fw-medium">Email</label>
                    <input type="email" class="form-control" id="loginEmail" placeholder="Email" required>
                    <div id="emailError" class="text-danger mb-2" style="display: none;"></div>
                </div>
                <div class="mb-4 position-relative">
                    <label for="loginPassword" class="form-label fw-medium">M·∫≠t kh·∫©u</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="loginPassword" placeholder="M·∫≠t kh·∫©u" required>
                        <span id="togglePassword" class="input-group-text" style="cursor: pointer;">üëÅ</span>
                    </div>
                    <div id="passwordError" class="text-danger mb-2" style="display: none;"></div>
                </div>
                
                <div id="loginError" class="text-danger mb-3" style="display: none;"></div>
                <button type="submit" class="btn-submit">ƒêƒÇNG NH·∫¨P</button>
                
            </form>
        </div>
    </div>
</div>  
<script>

    // Check if user is already logged in if yes redirect to home page

    async function checkUserLoginStatus() {
            try {
                const response = await fetch('/auth/user');
                const data = await response.json();
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error checking user login status:', error);
            }
        }
    // Ki·ªÉm tra email c√≥ ƒë√∫ng ƒë·ªãnh d·∫°ng kh√¥ng
        function validateLoginEmail() {
            const email = document.getElementById('loginEmail').value.trim();
            const emailError = document.getElementById('emailError');
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            if (!email) {
                emailError.textContent = "Vui l√≤ng nh·∫≠p email!";
                emailError.style.display = "block";
                return false;
            } else if (!emailPattern.test(email)) {
                emailError.textContent = "Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!";
                emailError.style.display = "block";
                return false;
            } else {
                emailError.style.display = "none";
                return true;
            }
        }

        // Ki·ªÉm tra m·∫≠t kh·∫©u c√≥ √≠t nh·∫•t 6 k√Ω t·ª± kh√¥ng
        function validateLoginPassword() {
            const password = document.getElementById('loginPassword').value.trim();
            const passwordError = document.getElementById('passwordError');

            if (!password) {
                passwordError.textContent = "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!";
                passwordError.style.display = "block";
                return false;
            } else if (password.length < 6) {
                passwordError.textContent = "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!";
                passwordError.style.display = "block";
                return false;
            } else {
                passwordError.style.display = "none";
                return true;
            }
        }
    
        document.getElementById('loginEmail').addEventListener('input', validateLoginEmail);
        document.getElementById('loginPassword').addEventListener('input', validateLoginPassword);

        document.getElementById('loginForm').addEventListener('submit', async function (event) {
                event.preventDefault();

                const emailValid = validateLoginEmail();
                const passwordValid = validateLoginPassword();

                if (!emailValid || !passwordValid) {
                    return; // N·∫øu c√≥ l·ªói, d·ª´ng form submit
                }

                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: "ƒêƒÉng nh·∫≠p th√†nh c√¥ng!",
                            text: "ƒêang chuy·ªÉn h∆∞·ªõng, vui l√≤ng ch·ªù...",
                            timer: 1200,
                            timerProgressBar: true,
                            showConfirmButton: false,
                        }).then(() => {
                            window.location.href = '/';
                        });
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: "Vui l√≤ng ki·ªÉm tra l·∫°i email ho·∫∑c m·∫≠t kh·∫©u!",
                        });
                    }
                } catch (error) {
                    console.error('Error during login:', error);
                    errorDiv.textContent = 'ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i sau.';
                    errorDiv.style.display = 'block';
                }
            });

    document.getElementById("togglePassword").addEventListener("click", function() {
    const passwordInput = document.getElementById("loginPassword");
    if (passwordInput.type === "password") {
        passwordInput.type = "text"; // Hi·ªÉn th·ªã m·∫≠t kh·∫©u
        this.innerHTML = "üö´"; // ƒê·ªïi icon th√†nh d·∫•u c·∫•m üö´
    } else {
        passwordInput.type = "password"; // ·∫®n m·∫≠t kh·∫©u
        this.innerHTML = "üëÅ"; // ƒê·ªïi l·∫°i icon m·∫Øt
    }
});
    // Check user role on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await checkUserLoginStatus();
    });
</script>